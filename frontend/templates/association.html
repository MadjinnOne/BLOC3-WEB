{% extends "base.html" %}

{% block title %}L'association{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/style_association.css">
<link rel="stylesheet" href="/static/css/style_vote.css">
{% endblock %}

{% block content %}
<section class="le-projet">
    <h1>L'esprit du projet</h1>
    <p>
        L'association de l'√©cole d'Avernas-le-Baudouin s'engage √† promouvoir une √©ducation d'excellence fond√©e sur des valeurs fondamentales : discipline, effort et respect.
    </p>
    <p>
        Nous encourageons les enseignants √† se surpasser dans leur engagement p√©dagogique, en adoptant une approche exigeante qui inspire les √©l√®ves √† viser l'excellence.
    </p>
    <p>
        L'association s'assure √©galement que l'√©cole reste un espace pr√©serv√© de toute influence id√©ologique inappropri√©e.
    </p>
    <p>
        Enfin, nous plaidons pour une discipline rigoureuse au sein de l'√©tablissement.
    </p>
</section>

{% if request.query_params.get("message") == "success" %}
<div class="vote-flash-success">
    <span class="vote-check">‚úÖ</span>
    Merci, votre vote a bien √©t√© enregistr√© !
</div>
{% elif request.query_params.get("message") == "already_voted" %}
<div class="vote-flash-success">
    <span class="vote-check">‚ö†Ô∏è</span>
    Vous avez d√©j√† vot√© pour cette proposition.
</div>
{% endif %}

<section class="votes-wrapper">
    <h2 class="votes-title"><span>üó≥Ô∏è</span> Votes</h2>

    {% if votes_en_cours %}
        <h3 class="votes-subtitle votes-encours-title">Votes en cours</h3>
        <div class="votes-grid">
            {% for vote in votes_en_cours %}
            <div class="vote-card" data-end="{{ vote.end_date.strftime('%Y-%m-%dT%H:%M:%S') }}" id="vote-{{ vote.id }}">
                <h3 class="vote-title">{{ vote.question }}</h3>
                {% set info = votes_info[vote.id] %}
                {% set total = info.total %}
                <div class="countdown" id="countdown-{{ vote.id }}">Temps restant : ...</div>
                {% if not has_voted[vote.id] %}
                <div class="vote-invite">
                    <span>üó≥Ô∏è</span> S√©lectionnez une option et cliquez sur ‚ÄúVoter‚Äù pour participer.
                </div>
                <form method="POST" action="/votes/{{ vote.id }}">
                    {% for opt in info.options %}
                    <label><input type="radio" name="option" value="{{ opt }}"> {{ opt }}</label><br>
                    {% endfor %}
                    <button>Voter</button>
                </form>
                {% else %}
                <div class="vote-feedback">
                    <span class="vote-check-icon">‚úîÔ∏è</span>
                    <span>Merci, votre vote a √©t√© pris en compte. Voici les r√©sultats‚ÄØ:</span>
                </div>
                <div class="vote-results-list">
                    {% for opt in info.options %}
                    <div class="vote-result-row">
                        <span class="vote-option-label">{{ opt }}</span>
                        <div class="vote-bar-container">
                            <div class="vote-bar" style="width: {{ (100 * info.results[opt] / (total if total else 1))|round(1) }}%"></div>
                        </div>
                        <span class="vote-percent">{{ (100 * info.results[opt] / (total if total else 1))|round(1) }}%</span>
                    </div>
                    {% endfor %}
                </div>
                <div class="vote-total"><strong>Total votes :</strong> {{ total }}</div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    {% endif %}

    {% if votes_termines %}
        <h3 class="votes-subtitle votes-termines-title">Votes termin√©s</h3>
        <div class="votes-grid votes-grid-terminees">
            {% for vote in votes_termines %}
            <div class="vote-card vote-terminee" id="vote-{{ vote.id }}">
                <h3 class="vote-title">{{ vote.question }}</h3>
                {% set info = votes_info[vote.id] %}
                {% set total = info.total %}
                <div class="vote-feedback">
                    <span class="vote-check-icon">üîí</span>
                    <span>Vote termin√©. R√©sultats finaux‚ÄØ:</span>
                </div>
                <div class="vote-results-list">
                    {% for opt in info.options %}
                    <div class="vote-result-row">
                        <span class="vote-option-label">{{ opt }}</span>
                        <div class="vote-bar-container">
                            <div class="vote-bar" style="width: {{ (100 * info.results[opt] / (total if total else 1))|round(1) }}%"></div>
                        </div>
                        <span class="vote-percent">{{ (100 * info.results[opt] / (total if total else 1))|round(1) }}%</span>
                    </div>
                    {% endfor %}
                </div>
                <div class="vote-total"><strong>Total votes :</strong> {{ total }}</div>
            </div>
            {% endfor %}
        </div>
    {% endif %}
</section>

<script src="/static/js/countdown.js"></script>
{% if request.query_params.get("voted_id") %}
<script>
    window.addEventListener("DOMContentLoaded", function() {
        const id = "{{ request.query_params.get('voted_id') }}";
        if (id) {
            const elt = document.getElementById("vote-" + id);
            if (elt) {
                elt.scrollIntoView({behavior: "smooth", block: "center"});
            }
        }
    });
</script>
{% endif %}
{% endblock %}
